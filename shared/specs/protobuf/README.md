# Generated Protobuf Malli Specs

This directory contains automatically generated Malli specifications from Protocol Buffer definitions.

## Overview

These specs are generated by the proto-explorer tool and provide:
- **Complete schema coverage** of all protobuf messages, enums, and oneofs
- **buf.validate constraint support** with all validation rules applied
- **Idiomatic Clojure naming** with automatic kebab-case conversion
- **Constraint-aware test data generation** for property-based testing

## Generated Files

- `cmd-specs.clj` - Root command message specs
- `cmd.*.clj` - Command specs organized by subsystem (CV, Compass, DayCamera, etc.)
- `ser-specs.clj` - Serialization/state message specs
- `buf.validate-specs.clj` - Validation rule specs
- `google.protobuf-specs.clj` - Standard protobuf type specs
- `malli_oneof.clj` - Custom Malli schema for protobuf oneofs
- `generators.clj` - Constraint-aware test data generators

## Usage in Main Application

```clojure
;; Require the namespace for the specs you need
(require '[potatoclient.specs.cmd :as cmd])
(require '[potatoclient.specs.cmd.RotaryPlatform :as rotary])
(require '[malli.core :as m])

;; Use specs for validation
(m/validate cmd/Root {:protocol-version 1 :cmd {:ping {}}})
;; => true

;; Get validation errors
(m/explain rotary/set-azimuth-value {:value 400})
;; => {:errors [{:path [:value], :in [:value], :schema [:< 360], :value 400}]}

;; Generate test data with constraints
(require '[malli.generator :as mg])
(mg/generate rotary/set-azimuth-value)
;; => {:value 234.5 :direction 1}  ; value always 0-360, direction never 0
```

## Constraint Examples

The specs include buf.validate constraints:

```clojure
;; SetAzimuthValue: value must be [0, 360)
potatoclient.specs.cmd.RotaryPlatform/set-azimuth-value
;; => [:map 
;;     [:value [:and [:maybe :double] [:>= 0] [:< 360]]]
;;     [:direction [:and [:maybe :potatoclient.specs.ser/jon-gui-data-rotary-direction]
;;                  [:not [:enum [0]]]]]]

;; SetElevationValue: value must be [-90, 90]
potatoclient.specs.cmd.RotaryPlatform/set-elevation-value
;; => [:map [:value [:and [:maybe :double] [:>= -90] [:<= 90]]]]
```

## Regenerating Specs

To regenerate these specs after protobuf changes:

```bash
cd tools/proto-explorer
make proto          # Generate proto files and JSON descriptors
make generate-specs # Convert JSON descriptors to Malli specs
```

## Using the Proto Explorer CLI

The proto-explorer tool provides a CLI for querying specs:

```bash
cd tools/proto-explorer

# Find specs by pattern
bb find rotary

# Get spec definition
bb spec :cmd.RotaryPlatform/set-velocity

# Generate example data
bb example :cmd.RotaryPlatform/set-azimuth-value

# Generate multiple examples
bb examples :cmd.RotaryPlatform/set-elevation-value 5
```

## Important Notes

1. **DO NOT EDIT** - These files are auto-generated and will be overwritten
2. **Namespace Convention** - Specs use `potatoclient.specs.*` namespaces
3. **Field Names** - All field names are converted to kebab-case
4. **Optional Fields** - All protobuf fields are wrapped with `:maybe`
5. **Oneofs** - Use custom `:oneof` schema for mutual exclusivity

## Troubleshooting

### Spec Not Found
- Ensure specs are loaded: `(require '[potatoclient.specs.cmd :as cmd])`
- Check the exact qualified keyword: `:cmd/Root` not `:cmd/root`

### Generation Failed
- Check protogen is up to date
- Verify JSON descriptors were generated: `ls output/json-descriptors/`
- Look for errors in spec generation: `make generate-specs`

### Validation Issues
- Remember all fields are optional (wrapped with `:maybe`)
- Check constraint ranges for numeric fields
- Enum values must match exactly (case-sensitive)

## See Also

- [Proto Explorer Documentation](../../../tools/proto-explorer/README.md)
- [Malli Documentation](https://github.com/metosin/malli)
- [buf.validate Documentation](https://docs.buf.build/buf-validate/overview)