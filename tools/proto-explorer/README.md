# Proto Explorer

A comprehensive protobuf message inspection tool that provides Java class information and Pronto EDN representations for protobuf messages.

## Overview

Proto Explorer is a command-line tool for exploring and inspecting protobuf message structures. It provides:

- **Java Class Information**: Detailed inspection of generated Java protobuf classes
- **Pronto EDN Output**: View the exact EDN structure that Pronto generates from protobuf messages
- **Field Mapping**: See how proto fields map to Java methods
- **Builder Information**: Explore Java builder methods for message construction

## Features

### 1. Pronto EDN Generation
Get the EDN (Clojure data) representation of any protobuf message as generated by Pronto. This is essential for:
- Understanding message structure for Malli specs
- Debugging protobuf-to-EDN conversions
- Documenting protocol structures

### 2. Java Class Inspection
Explore the generated Java classes:
- Field accessors and methods
- Inner classes and enums
- Builder patterns
- Protobuf descriptors

### 3. Field Mapping
View the complete mapping between:
- Proto field names
- Java getter methods
- JSON field names
- Field numbers

## Usage

### From Project Root

Proto Explorer is integrated into the main Makefile:

```bash
# Inspect a message with Java info and Pronto EDN
make proto-inspect MSG=Root           # Command root
make proto-inspect MSG=JonGUIState    # State root

# Run proto-explorer with any command
make proto-explorer ARGS="pronto-edn Root"
make proto-explorer ARGS="java-fields SetAzimuthValue"
make proto-explorer ARGS="java-builder Root"
```

### Direct Usage

From the proto-explorer directory:

```bash
# Get Pronto EDN representation
clojure -M:run:test-protos pronto-edn Root

# Get Java class summary with Pronto EDN
clojure -M:run:test-protos java-summary Root

# Get field mapping
clojure -M:run:test-protos java-fields SetAzimuthValue

# Get builder information
clojure -M:run:test-protos java-builder Root

# Get raw Java class info
clojure -M:run:test-protos java-class Root
```

## Commands

### `pronto-edn <message>`
Returns the Pronto EDN representation of a protobuf message with default values.

Example output:
```clojure
{:osd nil,
 :ping nil,
 :client_type :JON_GUI_DATA_CLIENT_TYPE_UNSPECIFIED,
 :session_id 0,
 :important false,
 :protocol_version 0}
```

### `java-summary <message>`
Provides a human-readable summary of the Java class including:
- Class information
- Field accessors
- Builder methods
- Pronto EDN representation

### `java-fields <message>`
Returns the proto field to Java method mapping as EDN:
```clojure
{:message "Root"
 :fields [{:proto-name "rotary"
           :number 1
           :json-name "rotary"
           :getter "getRotary"
           :has-method "hasRotary"}]}
```

### `java-builder <message>`
Returns information about the Java builder class and its methods.

### `java-class <message>`
Returns raw Java class information including methods, fields, and inner classes.

## Prerequisites

Before using Proto Explorer:

1. **Compile protobuf classes**:
```bash
make ensure-compiled
```

2. **Compile Pronto Java classes** (done automatically):
```bash
make ensure-pronto
```

## Architecture

Proto Explorer consists of:

- **`proto_explorer.main`**: Entry point and command dispatch
- **`proto_explorer.cli_jvm`**: JVM-based command implementations
- **`proto_explorer.java_class_info`**: Java reflection utilities
- **`proto_explorer.pronto_integration`**: Pronto EDN generation
- **`proto_explorer.json_to_edn`**: JSON descriptor parsing

## Dependencies

- Clojure 1.11.1
- Pronto (local fork with protobuf v4 support)
- Google Protobuf Java 4.29.2
- Various parsing and utility libraries

## Use Cases

### Creating Malli Specs
Use the Pronto EDN output as a template for Malli schemas:

```clojure
;; Based on proto-explorer pronto-edn output
(def CmdRoot
  [:map
   [:osd {:optional true} [:maybe OsdCommand]]
   [:ping {:optional true} [:maybe PingCommand]]
   [:client_type keyword?]
   [:session_id int?]
   [:important boolean?]
   [:protocol_version int?]])
```

### Understanding Message Structure
Quickly inspect any protobuf message without reading .proto files:

```bash
# See full structure with defaults
make proto-inspect MSG=SetAzimuthValue
```

### Debugging Protobuf Issues
Compare Java methods with proto fields to debug serialization issues:

```bash
# Check field mappings
make proto-explorer ARGS="java-fields YourMessage"
```

## Examples

### Inspect Command Root
```bash
$ make proto-inspect MSG=Root
# Shows Java class info and Pronto EDN structure
```

### Get EDN for Custom Message
```bash
$ make proto-explorer ARGS="pronto-edn SetAzimuthValue"
{:az 0.0, :force false}
```

### Explore Nested Messages
```bash
$ make proto-explorer ARGS="java-summary JonGUIState"
# Shows complete structure with nested messages
```

## Development

### Running Tests
```bash
clojure -M:test
```

### REPL Development
```bash
clojure -M:repl
```

## Notes

- Message names can be simple (e.g., "Root") or fully qualified (e.g., "cmd.JonSharedCmd$Root")
- The tool automatically finds the appropriate class based on the message name
- Pronto EDN shows default values for all fields
- All output is in EDN format for easy integration with Clojure tools