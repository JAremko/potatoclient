# Proto Tree Printer

A tool to display the EDN structure of protobuf messages as generated by Pronto, useful for creating Malli specs.

## Overview

This tool uses Pronto to convert protobuf message classes into EDN (Clojure data) format, showing the exact structure that Pronto generates. This is particularly useful when:
- Creating Malli specs for protobuf messages
- Understanding the structure of complex nested messages
- Debugging protobuf-to-EDN conversions
- Documenting the data structure of your protocol

## Prerequisites

Before using this tool, ensure:

1. The protobuf classes are compiled:
```bash
# From the project root
make ensure-compiled
```

2. Pronto's Java classes are compiled (this is done automatically when running the tool):
```bash
# If needed, compile manually from project root
cd examples/pronto && javac -cp "$(clojure -Spath)" -d target/classes src/java/pronto/*.java
```

## Usage

### From this directory

```bash
# Print command message structure as EDN
make print-cmd

# Print state message structure as EDN
make print-state

# Print both structures
make print-both
```

### From project root

The main Makefile provides convenient targets:

```bash
# Print command EDN structure
make print-tree-cmd

# Print state EDN structure
make print-tree-state

# Print both EDN structures
make print-trees
```

## Output Format

The tool displays protobuf messages as EDN maps showing:
- All fields with their default values
- Field names as keywords
- Nested messages as nil (when empty) or nested maps
- Enums as keywords
- Repeated fields as vectors

Example output:
```clojure
{:osd nil,
 :ping nil,
 :client_type :JON_GUI_DATA_CLIENT_TYPE_UNSPECIFIED,
 :system nil,
 :session_id 0,
 :important false,
 :rotary nil,
 :compass nil,
 :protocol_version 0}
```

## How It Works

1. **Pronto Mappers**: The tool defines Pronto mappers for the root protobuf message classes
2. **Proto-Maps**: Creates Pronto proto-maps (protobuf-aware Clojure maps) from the message classes
3. **EDN Conversion**: Converts proto-maps to regular Clojure maps (EDN-serializable)
4. **Pretty Printing**: Outputs the structure using Clojure's pprint for readability

## Technical Details

- Uses Pronto library for protobuf-to-EDN conversion
- Pronto is a custom fork with protobuf v4 support
- Message classes are from compiled protobuf definitions
- Root messages:
  - Commands: `cmd.JonSharedCmd$Root`
  - State: `ser.JonSharedData$JonGUIState`

## Use Cases

### Creating Malli Specs

The EDN output can be used as a template for Malli schemas:

```clojure
;; Based on the EDN structure from proto-tree-printer
(def CmdRoot
  [:map
   [:osd {:optional true} [:maybe OsdCommand]]
   [:ping {:optional true} [:maybe PingCommand]]
   [:client_type keyword?]
   [:session_id int?]
   [:important boolean?]
   [:protocol_version int?]])
```

### Understanding Message Structure

Quickly see all available fields and their types without reading .proto files or generated Java code.

### Validation Testing

Compare actual protobuf messages with their expected EDN structure during testing.

## Files

- `deps.edn` - Dependencies (pronto, protobuf)
- `src/proto_tree_printer/core.clj` - Main implementation
- `Makefile` - Convenient make targets
- `README.md` - This file

## Dependencies

- Clojure 1.12.1
- Pronto (local fork with protobuf v4 support)
- Google Protobuf Java 4.29.2
- Compiled protobuf classes from main project